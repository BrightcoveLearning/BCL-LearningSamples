<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>On-Demand AdRequest Example</title>

  <link href="node_modules/video.js/dist/video-js/video-js.css" rel="stylesheet">
  <link href="node_modules/videojs-contrib-ads/src/videojs.ads.css" rel="stylesheet">
  <link href="src/videojs.ima3.css" rel="stylesheet">

  <!-- video.js -->
  <script src="node_modules/video.js/dist/video-js/video.js"></script>

  <!-- Media Sources plugin -->
  <script src="node_modules/videojs-contrib-hls/node_modules/videojs-contrib-media-sources/src/videojs-media-sources.js"></script>

  <!-- HLS plugin -->
  <script src="node_modules/videojs-contrib-hls/src/videojs-hls.js"></script>

  <!-- segment handling -->
  <script src="node_modules/videojs-contrib-hls/src/xhr.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/flv-tag.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/stream.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/exp-golomb.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/h264-stream.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/aac-stream.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/metadata-stream.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/segment-parser.js"></script>

  <!-- m3u8 handling -->
  <script src="node_modules/videojs-contrib-hls/src/m3u8/m3u8-parser.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/playlist-loader.js"></script>

  <script src="node_modules/videojs-contrib-hls/node_modules/pkcs7/dist/pkcs7.unpad.js"></script>
  <script src="node_modules/videojs-contrib-hls/src/decrypter.js"></script>

  <script src="node_modules/videojs-contrib-hls/src/bin-utils.js"></script>

  <!-- ima3 -->
  <script src="dist/videojs.ima3.min.js"/></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .info {
      background-color: #eee;
      border: thin solid #333;
      border-radius: 3px;
      padding: 0 5px;
      margin: 20px 0;
    }
  </style>

</head>
<body>
  <div class="info">
    <p>  The video in this example has id3 tags embedded it. If you view the source of this page, you can see how
  these tags are used to create a new cuepoint on the timeline and trigger an on-demand ad request..</p>
  </div>
  <video id="video"
         class="video-js vjs-default-skin"
         height="300"
         width="600"
         controls>
    <source
       src="https://bcvid.brightcove.com/players-example-content/id3-metadata/index.m3u8"
       type="application/x-mpegURL"/>
  </video>
  <ol id="cuelog"></ol>
  <script>
    var
      testCue,
      player = videojs('video'),
      cuelog = document.querySelector('#cuelog'),
      player;

    // initialize the player
    videojs.options.flash.swf = 'node_modules/video.js/dist/video-js/video-js.swf';
    player.ima3({
      //adTechOrder: ['html5','flash'],
      adTechOrder: ['flash'],
      adSwf: 'dist/videojs.ima3.swf',
      debug: true,
      serverUrl: ''
    });

    // wait for "loadeddata" to guarantee that the ID3 info has been
    // parsed out of the video

    player.on('loadeddata', function() {

      // find the metadata track
      var tracks = player.textTracks(),
          track, i;
      for (i = 0; i < tracks.length; i++) {
        track = tracks[i];
        if (track.kind === 'metadata') {

          // listen for cuechange events and output the cue text value
          track.on('cuechange', function() {
            var li = document.createElement('li');

            // in reality, there may be more than one cue active at a time
            // we'll ignore that for simplicity in this example
            if (track.activeCues.length) {
              var
                cue,
                cueString = track.activeCues[0].text;

              li.textContent = cueString;
              cuelog.appendChild(li);

              //When reading the cues, there was a null char at the end of the text
              //that was making the JSON.parse below throw.  Filtering out any terminating
              //null chars.  I think this is a bug in the ID3 parser though.
              if (cueString.charCodeAt(cueString.length - 1) === 0) {
                cueString = cueString.slice(0,-1);
              }
              cue = JSON.parse(cueString);
              if (cue.name === 'AdCue') {
                var
                  Cue = window.VTTCue || window.TextTrackCue,
                  tracks = player.remoteTextTracks(),
                  //I couldn't get cue points to fire that had a time that matched
                  //duration of the video.  I think this is a bug in the cue points.
                  //vttCue = new Cue(, cue.time, 'AdRequestCue');
                  //console.log('appending on demand cue at ', cue.time);
                  vttCue = new Cue(12.0, 12.0, '{"name": "AdRequestCue"}');
                  console.log('appending on demand cue at 12.0 seconds');
                track.addCue(vttCue);
              } else if (cue.name === 'AdRequestCue') {
                player.ima3.adrequest('//pubads.g.doubleclick.net/gampad/ads?sz=640x360&iu=/6062/iab_vast_samples/skippable&ciu_szs=300x250,728x90&impl=s&gdfp_req=1&env=vp&output=xml_vast2&unviewed_position_start=1&url=[referrer_url]&correlator=[timestamp]');
              }
            }
          });
          break;
        }
      }
    });
</script>
</body>
</html>