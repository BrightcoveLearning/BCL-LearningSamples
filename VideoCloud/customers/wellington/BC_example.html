<!DOCTYPE html>
<html>
	<head>
		<title>Player API Chaptering Example</title>
		<style>
		body {
    font-family: Helvetica,Arial,sans-serif;
  }
  .BrightcoveExperience {
    margin-left: 5px;
  }
  .BCL_chapterlist {
    position: absolute;
    left: 485px;
    top: 0px;
    background-color: #eeeeee;
    border: 1px #999 solid;
    font-size: 10px;
    text-align: left;
    height: 270px;
    width: 200px;
    overflow: scroll;
  }
  .BCL_chapter {
    background-color: #eeeeee;
    background-image: -webkit-gradient(radial, 50% 50%,0,50% 50%,200, from(#cccccc), to(#eeeeee));
    background-image: -webkit-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -moz-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -o-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -ms-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: radial-gradient(50% 50%, #eeeeee, #cccccc);
    border: 1px #999 solid;
    margin: 4px;
    padding: 4px;
    color: #666666;
  }
  .BCL_selected {
    background-color: #ffffff;
    background-image: -webkit-gradient(radial, 50% 50%,0,50% 50%,200, from(#eeeeee), to(#ffffff));
    background-image: -webkit-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -moz-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -o-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -ms-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: radial-gradient(50% 50%, #ffffff, #eeeeee);
  }
  .BCL_title-selected {
    color: #64AAB2;
  }
  .BCL_player-container {
    position: relative;
    width: 680px;
    height: 270px;
  }
  .BCL_thumbnail {
    margin-top: 5px;
    margin-bottom: 5px;
    margin-right: 5px;
    vertical-align: middle;
  }
  .BCL_title {
    font-size: 14px;
  }
  .BCL_time {
    font-size: 10px;
    float: right;
    margin-top: 40px;
  }
  .BrightcoveExperience {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 480px;
    height: 100%;
  }
  .BCL_hidden {
    visibility: hidden;
    /* display: none; */
    z-index: -1;
  }
		</style>
	</head>
	<body>
		<h1>Player API Chaptering Example</h1>
		<p>The player below plays a single video. The "playlist" is a set of chapters that are defined by cue points set in the video. The cue point name is the name of the chapter, and the cue point metadata contains the URL for a thumbnail image. The chapters are hidden until the video starts playing, because seek() does not work unless the video is playing, and on iOS devices, the initial playback must be initiated by the user.</p>
		<p><small><em>The buttons below are for development purposes only, to switch between Flash and  HTML5 players. Do not use these in production, as the method is unsupported. You should let the Smart Player decide whether to load Flash or HTML5 instead</em>.</small></p>
		<div id="modeSwitch">
			<button onclick="switchToHTML5()" style="margin-bottom: 20px;margin-right: 10px;">Switch to HTML5 Player</button>
			<button onclick="switchToFlash()" style="margin-bottom: 20px;">Switch to Flash Player</button>
		</div>
	  <div class="BCL_player-container">
			<!-- Start of Brightcove Player -->
			<script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"></script>

			<object id="myExperience" class="BrightcoveExperience">
				<param name="bgcolor" value="#FFFFFF" />
				<param name="width" value="480" />
				<param name="height" value="270" />
				  <param name="playerID" value="1691758019001" />
				  <param name="playerKey" value="AQ~~,AAABioIY7BE~,DgYQJrQaZrLJSPd9A_TZJnnCQh8bz7fF" />
				<param name="isVid" value="true" />
				<param name="isUI" value="true" />
				<param name="dynamicStreaming" value="true" />
				<param name="@videoPlayer" value="1808748457001" />
				<!-- params for Smart Player API -->
				<param name="includeAPI" value="true" />
				<param name="templateReadyHandler" value="onTemplateReady" />
			</object>

			<script type="text/javascript">brightcove.createExperiences();</script>

			<!-- End of Brightcove Player -->

			<div id="BCL_chapterlist" class="BCL_chapterlist"></div>
	  </div>
		<!-- include jquery and handlebars.js templating system -->
		<script type="text/javascript" src="http://files.brightcove.com/jquery-1.8.1.min.js"></script>
		<script type="text/javascript" src="http://files.brightcove.com/handlebars-1.0.0.beta.6.js"></script>
		<script type="text/javascript">
			(function(window) {
      var chapterTime, chapterName, player, videoPlayer, cuePointsModule, postrollID, restartPoint;
      var $chapterlist = $('#BCL_chapterlist');
      $chapterlist.hide();
      var chaptersOn = false;
      var chaptersShowing = false;
      var cuePointDataObj = {};
				// define the template for the chapters list
				var chaptersTemplate = "{{#cuePointData}}<div id=\"{{name}}\" data-time=\"{{time}}\" class=\"BCL_chapter\"><img class=\"BCL_thumbnail\" height=\"45\" width=\"60\" src=\"{{metadata}}\"/> <span class=\"BCL_title\">{{name}}</span> <span class=\"BCL_time\">{{formattedTime.m}}:{{formattedTime.s}}</span></div>{{/cuePointData}}";
				// event listener for the player being ready
				onTemplateReady = function(event) {
					log("template ready");
					// get modules
					player = brightcove.api.getExperience("myExperience");
					videoPlayer = player.getModule(brightcove.api.modules.APIModules.VIDEO_PLAYER);
					// add listener for begin event
					videoPlayer.addEventListener(brightcove.api.events.MediaEvent.BEGIN,onMediaBegin);
					cuePointsModule = player.getModule(brightcove.api.modules.APIModules.CUE_POINTS);
					// capture the original video id to get the cue points
	        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.PLAY, onMediaPlay);
	        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.STOP, onMediaStop);
	        cuePointsModule.addEventListener(brightcove.api.events.CuePointEvent.CUE, onCuePoint);
	        // check first video for chapters and postrolls
	        videoPlayer.getCurrentVideo(function (videoDTO) {
	          // call getCuePoints
	          getCuePoints(videoDTO.id);
	          if (videoDTO.customFields.postrollmessage) {
	            postrollsOn = true;
	            postrollID = videoDTO.customFields.postrollmessage;
	            originalID = videoDTO.id;
	          }
	          else {
	            postrollsOn = false;
	          }
	        });
				 }
				// function get cue points
				function getCuePoints(videoID) {
					cuePointsModule.getCuePoints(videoID, function(cuePointData) {
						log(cuePointData);
						// sort the array to get cue points in order
						cuePointData.sort( function(a,b) {
							return a.time - b.time;
						});
						// remove the preroll and postroll cue points
						cuePointData.splice(0,1);
						cuePointData.splice((cuePointData.length -1),1);
						// add formatted time objects for each cue point
						for (var i in cuePointData) {
							cuePointData[i].formattedTime = secondsToTime(cuePointData[i].time);
						}
						// add the cue point data to the data object for Handlebars
						cuePointDataObj.cuePointData = cuePointData;
						// populate the template with data - standard Handlebars procedure here
						var template = Handlebars.compile(chaptersTemplate);
						var data = cuePointDataObj;
						var results = template(data);
						// inject the results into the page
						document.getElementById("BCL_chapterlist").innerHTML = results;
						// set click handler for chapter elements
						$('.BCL_chapter').on('click',function(){
							var $this = $(this);
							var newTime = $this.attr("data-time");
							var name = $this.attr("id");
							playChapter(name,newTime);
						});
					})
				}
				// play the chapter
				function playChapter(name,newTime) {
					chapterTime = newTime;
					videoPlayer.getIsPlaying(function(isPlaying){
						if (isPlaying == true) {
							videoPlayer.seek(chapterTime);
						} else {
							videoPlayer.play();
							// delay by a second to give the video time to buffer
							var t = window.setTimeout(seekToChapter,1000);
						}
					});
					highlight(name);
				}
      // media begin handler
      onMediaBegin = function (evtObject) {
        // call the change event handler to execute it for the initial video
        showChapterList();
      }
      // media play handler
      onMediaPlay = function (evtObject) {
        log("media play");
        showChapterList();
      };
      // media stop handler
      onMediaStop = function (evtObject) {
        log("media stop");
        // hideChapterList();
      };
      // cue point handler
      onCuePoint = function (evtObject) {
        log("cue point");
        highlight(evtObject.cuePoint.name);
      };
			// highlight utility
			function highlight(name) {
				log(name);
				var thisID = "#" + name;
				//log(thisID);
				var $this = $(thisID);
				// log($this.attr("id"));
				// // de-highlight all items
				$this.siblings().removeClass("BCL_highlight");
				$this.addClass("BCL_highlight");
				// log($this.attr("class"));
			} 
			// seek utility function
			function seekToChapter(){
					videoPlayer.getIsPlaying(function(data) {
						if (data == true) {
							videoPlayer.seek(chapterTime);
						} else {
							videoPlayer.play();
							// if video wasn't playing, need to allow time for buffering before seek
							var t = window.setTimeout(seekToChapter,1000);
							// playChapter(time);
						}
					});
				}			
      // show chapter list
      showChapterList = function () {
        if (!chaptersShowing) {
          $chapterlist.fadeIn(300);
          chaptersShowing = true;
        };
        return;
      };
      // hide chapter list
      hideChapterList = function () {
        if (chaptersShowing) {
          $chapterlist.fadeOut(300);
          chaptersShowing = false;
        };
        return;
      };
      // highlighting utility
      highlight = function(name) {
        log(name);
        var thisID = "#" + name;
        //log(thisID);
        var $this = $(thisID);
        // log($this.attr("id"));
        // // de-highlight all items
        $this.siblings().removeClass("BCL_selected");
        $this.addClass("BCL_selected");
        return;
      };
      // seconds to readable time utility
      secondsToTime = function (secs) {
        var hours = Math.floor(secs / (60 * 60));
        if (hours < 10) {
          hours = "0" + hours;
        }
        var divisor_for_minutes = secs % (60 * 60);
        var minutes = Math.floor(divisor_for_minutes / 60);
        if (minutes < 10) {
          minutes = "0" + minutes;
        }
        var divisor_for_seconds = divisor_for_minutes % 60;
        var seconds = Math.ceil(divisor_for_seconds);
        if (seconds < 10) {
          seconds = "0" + seconds;
        }
        var obj = {
          "h":hours,
          "m":minutes,
          "s":seconds
        };
        return obj;
      };
      // for development purposes only: reopen page with HTML5 player
      window.switchToHTML5 = function () {
        var separator = "?";
        if (document.location.href.indexOf("?", 0) > -1) {
          separator = "&";
        }
        window.location = document.location.href + separator + "forceHTML=true";
      };
      // for development purposes only: switch back to Flash
      window.switchToFlash = function () {
        var startOfQuery = document.location.href.indexOf("forceHTML", 0) - 1;
        window.location = document.location.href.substring(0, startOfQuery);
      };
      // wrapper for logging
      log = function (message) {
        if (window["console"] && console["log"]) {
          var d = Date.now();
          d = d.toLocaleString();
          console.log(d + ":");
          console.log(message);
          return;
        }
      };
		})(window);
		</script>
	</body>
</html>
