
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
		<title>Video Data to CVS</title>
				<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<style type="text/css">
			body {
				font-family : Helvetica,Arial,sans-serif;
				color : #619FA8;
				padding: 0px 50px 50px 50px;
			}
			legend {
				color: #CF0050;
			}
			.content {
								width: 900px;
			}
			.button {
				background-color: #f5f5f5;
				background-image: -webkit-gradient(linear, left top, left bottom, from(#f5f5f5), to(#999999));
				background-image: -webkit-linear-gradient(top, #f5f5f5, #999999);
				background-image: -moz-linear-gradient(top, #f5f5f5, #999999);
				background-image: -o-linear-gradient(top, #f5f5f5, #999999);
				background-image: -ms-linear-gradient(top, #f5f5f5, #999999);
				background-image: linear-gradient(top, #f5f5f5, #999999);
				filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0,StartColorStr='#f5f5f5', EndColorStr='#999999');
				color: #990000;
				border: #999 1px solid;
				border-radius: 10px;
				padding: 5px;
				cursor: pointer;
			}
			.videoTitle {
				font-weight: bold;
				color: #990000;
			}
			#pages {
				font-weight: bold;
				color: #990000;
			}
			.aside {
				color: #990000;
				font-style: italic;
				background-color: #CCC;
				border: #999 1px solid;
				border-radius: 10px;
				padding: 5px;
				width: 550px;
			}
			#results {
				font-family: monospace;
				background-color: #F4F4F4;
				padding: 10px;
				border: #999 1px solid;
				width: 100%;
				height: 400px;
			}
		</style>
		<!-- Javascript Media API wrapper from opensource.brightcove.com -->
		<script type="text/javascript" src="http://files.brightcove.com/bc-mapi.js"></script>

	</head>
	<body>
		<div class="content">
			<h2>Video Data Retriever</h2>
				<p>This is a utility for dumping out the video metadata for your Video Cloud videos in CSV format. Feel free to take the source code and use or modify it, but take note:</p>
				<p class="aside">You should not post this page on a public-facing server - it is never a good idea to expose Media API tokens in page contents or source code.</p>
				<p>Enter your Media API <strong>Read</strong> token</p>
				<p><input id="token" size="100" value="jUPgZ3EQYo26aTy2Y7_RZ4JWOyou9XyMna9fvkmT1IiQ8a9cHlHcCQ.." /></p>
				<!-- <p>Items per page:
					<select id="pageSize">
						<option>5</option>
						<option>10</option>
						<option>25</option>
						<option>50</option>
						<option selected="selected">100</option>
					</select>
				</p> -->
				<!-- <p>Total number of items: <span id="pages">???</span></p>
				<p>Page to display: <select id="pageSelector" onchange="getVideoData()">
					<option>1</option>
				</select></p> -->
				<p><span class="button" onclick="getAllVideos()">Get Video Data</span>
			</div>
			<textarea id="results"></textarea>
		<script type="text/javascript">
			// BCL Media API search maker -- adapted from JS-MAPI on opensource.brightcove.com
			// namespace to keep all the "global" vars together
			(function() {
				// set header row for CSV data
				var CSVstr = "RefrenceID, Video ID,OMSID,Title,Tags,Video Type,Item State,Short Description,Creation Date<br />";
				var total_count,page_number,pages;
				var token = document.getElementById("token").value;
				var fields = "referenceID,id,creationDate,name,tags,itemState,shortDescription";
				var custom_fields = "omsid,videotype";
				var pageSize = 100;
				window.addEventListener('load', function() {
	                getInitialData();
	            }, false);
				// get initial data
				getInitialData = function() {
					if (token === "") {
						alert("Please enter your Media API Read token");
					}
					BCMAPI.token = token;
					BCMAPI.callback = "onInitialResponse";
					var params = {};
					// use next line to limit fields returned
					params.video_fields = "id";
					params.page_size = 1;
					params.get_item_count = true;
					params.filter = "PLAYABLE,INACTIVE";
					params.from_date = 22092873;
					BCMAPI.find("find_modified_videos",params);

				}
				// get form data and make the Media API call
				getVideoData = function(page) {
					if (token === "") {
						alert("Please enter your Media API Read token");
					}
					BCMAPI.token = token;
					BCMAPI.callback = "onSearchResponse";
					var params = {};
					// use next line to limit fields returned
					params.video_fields = fields;
					params.custom_fields = custom_fields;
					params.page_size = parseInt(pageSize);
					params.page_number = page;
					params.get_item_count = true;
					params.filter = "PLAYABLE,INACTIVE";
					params.from_date = 22092873;
					BCMAPI.find("find_modified_videos",params);
				}
				// handler for initial response
				onInitialResponse = function(jsonData) {
					total_count = jsonData.total_count;
					pages = Math.ceil(jsonData.total_count / 100);
					log(jsonData);
					log(pages);
				}
				// handler for general response
				onSearchResponse = function(jsonData) {
					log(jsonData.total_count);
					var video = {};
					// add video data to buffer
					addVideoData(jsonData);
					// if we're done, write results
					if (jsonData.page_number == (pages - 1)) {
						document.getElementById("results").innerHTML = CSVstr;

					}
				}
				// addOption = function(selectID, display, value) {
				//   var obj = document.getElementById(selectID);
				//   obj.options[obj.options.length] = new Option(display, value);
				// }
				getAllVideos = function() {
						log(pages);
						for (var i=0; i<=pages; i++){
							getVideoData(i);
						};
				}
				// add video data to string buffer
				addVideoData = function(jsonData) {
					for (var index in jsonData.items) {
						video = jsonData.items[index];
						var date = new Date(parseInt(video.creationDate));
						video.creationDate = date.toLocaleString();
						if (!video.customFields){
							video.customFields = {};
							video.customFields.omsid = "";
							video.customFields.videotype = "";
						}
						else if (!video.customFields.omsid) {
							video.customFields.omsid = "";
						}
						else if (!video.customFields.videotype) {
							video.customFields.videotype = "";
						}
						else if (!video.shortDescription) {
							video.shortDescription = "";
						};
						var reNewLines=/[\n\r]/g;
						video.customFields.omsid=video.customFields.omsid.replace(reNewLines, " ");
						if (video.shortDescription !== null) {
							video.shortDescription = fixShortDescription(video.shortDescription);
						}
						else {
							video.shortDescription = ""
;						}
						//log(video.customFields.omsid)
						CSVstr += "&quot;" + video.referenceId + "&quot;,&quot;" + video.id + "&quot;,&quot;" + video.customFields.omsid + "&quot;,&quot;" + video.name + "&quot;,&quot;" + video.tags.join() + "&quot;,&quot;" + video.customFields.videotype + "&quot;,&quot;" + video.itemState + "&quot;,&quot;" + escape(video.shortDescription) + "&quot;,&quot;" + video.creationDate+ "&quot;\n"
					}
				}
				// utility to replace problematic characters in short description
				fixShortDescription = function(str) {
					var ss1,ss2,strURL;
					var idx = str.indexOf("http");
					if (idx > -1) {
						// log(str);
						ss1 = str.substring(0,(idx-1));
						// log(ss1);
						str = str.substring(idx,str.length);
						// log(str);
						idx2 = str.indexOf(" ");
						if (idx2 > -1) {
							// log(idx2);
							strURL = ss1.substring(0,(idx2-1));
							ss2 = str.substring(idx2,(str.length-1));
							// log(ss2);
						}
						else {
							strURL = str;
							ss2 = "";
						}
						// log(strURL)
						strURL = escape(strURL);
						str = ss1.concat(strURL,ss2);
						// log(str);
						return str;
					}
					else {return str;}
				}
				// debugging tool - wraps log to avoid errors in IE 7 & 8
				function log(message) {
				  if (window["console"] && console["log"]) {
				    var d = new Date();
				    console.log(d + ": ");
				    console.log(message);
				  }
				}

			})();

		</script>
	</body>
</html>
