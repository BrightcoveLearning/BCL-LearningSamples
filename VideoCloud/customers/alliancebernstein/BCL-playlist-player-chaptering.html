<!DOCTYPE html>
<html>
  <head>
  <title>Player API Chaptering Example</title>
  <style>
  body {
    font-family: Helvetica,Arial,sans-serif;
  }
  .BrightcoveExperience {
    margin-left: 5px;
  }
  .BCL_chapterlist {
    position: absolute;
    left: 658px;
    top: 34px;
    background-color: #eeeeee;
    border: 1px #999 solid;
    font-size: 10px;
    text-align: left;
    height: 358px;
    width: 300px;
    overflow: scroll;
  }
  .BCL_chapter {
    background-color: #eeeeee;
    background-image: -webkit-gradient(radial, 50% 50%,0,50% 50%,200, from(#cccccc), to(#eeeeee));
    background-image: -webkit-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -moz-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -o-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: -ms-radial-gradient(50% 50%, #eeeeee, #cccccc);
    background-image: radial-gradient(50% 50%, #eeeeee, #cccccc);
    border: 1px #999 solid;
    margin: 4px;
    padding: 4px;
    color: #666666;
  }
  .BCL_selected {
    background-color: #ffffff;
    background-image: -webkit-gradient(radial, 50% 50%,0,50% 50%,200, from(#eeeeee), to(#ffffff));
    background-image: -webkit-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -moz-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -o-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: -ms-radial-gradient(50% 50%, #ffffff, #eeeeee);
    background-image: radial-gradient(50% 50%, #ffffff, #eeeeee);
  }
  .BCL_title-selected {
    color: #64AAB2;
  }
  .BCL_player-container {
    position: relative;
    width: 960px;
    height: 445px;
  }
  .BCL_thumbnail {
    margin-top: 10px;
    margin-bottom: 10px;
    margin-right: 5px;
    vertical-align: middle;
  }
  .BCL_title {
    font-size: 16px;
  }
  .BCL_time {
    font-size: 10px;
    float: right;
    margin-top: 60px;
  }
  .BrightcoveExperience {
    position: absolute;
    top: 0px;
    left: 0px;
    width: 100%;
    height: 100%;
  }
  .BCL_hidden {
    visibility: hidden;
    /* display: none; */
    z-index: -1;
  }
  </style>
  <!-- include jQuery - 1.7 or later will work -->
  <script type="text/javascript" src="http://files.brightcove.com/jquery-1.8.1.min.js"></script>
  <!-- include handlebars.js templating system -->
  <script type="text/javascript" src="http://files.brightcove.com/handlebars-1.0.0.beta.6.js"></script>
  </head>
  <body>
  <h1>Player API Chaptering Example</h1>
  <p>The player below plays playlists. The "playlist" below the player is a set of chapters that are defined by <strong>code</strong> cue points set in the video. The cue point <strong>name</strong> is the name of the chapter, and the cue point <strong>metadata</strong> contains the URL for a thumbnail image.</p>
  <p><small><em>The buttons below are for development purposes only, to switch between Flash and  HTML5 players. Do not use these in production, as the method is unsupported. You should let the Smart Player decide whether to load Flash or HTML5 instead</em>.</small></p>
  <div id="modeSwitch">
    <button onclick="switchToHTML5()" style="margin-bottom: 20px;margin-right: 10px;">Switch to HTML5 Player</button>
    <button onclick="switchToFlash()" style="margin-bottom: 20px;">Switch to Flash Player</button>
  </div>
  <div class="BCL_player-container">
    <!-- Start of Brightcove Player -->
    <div style="display:none">
    Do not delete!
    </div>
    <script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"></script>
  
    <object id="myExperience" class="BrightcoveExperience">
      <param name="bgcolor" value="#FFFFFF" />
      <param name="width" value="960" />
      <param name="height" value="445" />
      <param name="playerID" value="1651420050001" />
      <param name="playerKey" value="AQ~~,AAAA1oy1bvE~,ALl2ezBj3WEh_ESE4RYJUGyoTZueLq5e" />
      <param name="isVid" value="true" />
      <param name="isUI" value="true" />
      <param name="dynamicStreaming" value="true" />
      <param name="wmode" value="transparent" />
        <!-- params for Universal Player API -->
      <param name="includeAPI" value="true" />
      <param name="templateReadyHandler" value="onTemplateReady" />
    </object>
  
    <!--
    This script tag will cause the Brightcove Players defined above it to be created as soon
    as the line is read by the browser. If you wish to have the player instantiated only after
    the rest of the HTML is processed and the page load is complete, remove the line.
    -->
    <script type="text/javascript">brightcove.createExperiences();</script>
  
    <!-- End of Brightcove Player -->
    <div id="BCL_chapterlist" class="BCL_chapterlist"></div>
  </div>
  <script type="text/javascript">
    // everythings in a self-executing function to avoid collisions in the global namespace
    (function() {
      // save a reference to the jquery-wrapped chapter list element
      var chapterTime, chapterName, player, videoPlayer, cuePointsModule, postrollID, originalID, restartPoint;
      var $chapterlist = $('#BCL_chapterlist');
      $chapterlist.hide();
      var chaptersOn = false;
      var chaptersShowing = false;
      var postrollsOn = false;
      var cuePointDataObj = {};
      var skipGetCuePoints = false;
      // define the template for the chapters list
      chaptersTemplate = "{{#cuePointData}}<div id=\"{{name}}\" data-time=\"{{time}}\" class=\"BCL_chapter\"><img class=\"BCL_thumbnail\" height=\"60\" width=\"80\" src=\"{{metadata}}\"/> <span class=\"BCL_title\">{{name}}</span> <span class=\"BCL_time\">{{formattedTime.m}}:{{formattedTime.s}}</span></div>{{/cuePointData}}";
      // event listener for the player being ready
      onTemplateReady = function (event) {
        // get modules
        player = brightcove.api.getExperience("myExperience");
        videoPlayer = player.getModule(brightcove.api.modules.APIModules.VIDEO_PLAYER);
        cuePointsModule = player.getModule(brightcove.api.modules.APIModules.CUE_POINTS);
        // add listeners for media change, play, and stop, complete, and for cue points
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.CHANGE, onMediaChange);
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.PLAY, onMediaPlay);
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.STOP, onMediaStop);
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.COMPLETE, onMediaComplete);
        cuePointsModule.addEventListener(brightcove.api.events.CuePointEvent.CUE, onCuePoint);
        // check first video for chapters and postrolls
        videoPlayer.getCurrentVideo(function (videoDTO) {
          // call getCuePoints
          getCuePoints(videoDTO.id);
          if (videoDTO.customFields.postrollmessage) {
            postrollsOn = true;
            postrollID = videoDTO.customFields.postrollmessage;
            originalID = videoDTO.id;
          }
          else {
            postrollsOn = false;
          }
        });
      }
      // media change handler
      onMediaChange = function (evtObject) {
        log("media change");
        // check to see if this is a postroll video loading
        if (skipGetCuePoints) {
          log("chapter postroll now");
          return;
        }
        else {
          getCuePoints(evtObject.media.id);
          if (evtObject.media.customFields.postrollmessage) {
            postrollsOn = true;
            postrollID = evtObject.media.customFields.postrollmessage;
            originalID = evtObject.media.id;
          }
          else {
            postrollsOn = false;
          }
        }
      };
      // media begin handler
      onMediaBegin = function (evtObject) {
        // call the change event handler to execute it for the initial video
        onMediaChange(evtObject);
      }
      // media play handler
      onMediaPlay = function (evtObject) {
        log("media play");
        showChapterList();
      };
      // media stop handler
      onMediaStop = function (evtObject) {
        log("media stop");
        hideChapterList();
      };
      // media complete handler
      onMediaComplete = function (evtObject) {
        log("media complete");
        skipGetCuePoints = false;
        if (postrollsOn) {
          playPostroll(postrollID);
        }
      }
      // cue point handler
      onCuePoint = function (evtObject) {
        log("cue point");
        highlight(evtObject.cuePoint.name);
        skipGetCuePoints = true;
        // cue point time is greater than 1 second, we should be past the first chapter
        if (evtObject.cuePoint.time > 1 && postrollsOn) {
          // set the return time a little ahead so we don't get into a loop
          chapterTime = evtObject.cuePoint.time + .1;
          chapterName = evtObject.cuePoint.name;
          videoPlayer.pause(true);
          playPostroll(postrollID);
        }
        else {
          return;
        }
      };
      // play postroll 
      playPostroll = function(postrollID) {
        log("play postroll");
        videoPlayer.removeEventListener(brightcove.api.events.MediaEvent.COMPLETE, onMediaComplete);
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.COMPLETE, onPostrollComplete);
        videoPlayer.loadVideoByID(postrollID);
      }
      // postroll complete handler
      onPostrollComplete = function(evtObject) {
        log("postroll complete");
        log(originalID);
        log(chapterName);
        videoPlayer.removeEventListener(brightcove.api.events.MediaEvent.COMPLETE, onPostrollComplete);
        videoPlayer.loadVideoByID(originalID);
        playChapter(chapterName,chapterTime);
        videoPlayer.addEventListener(brightcove.api.events.MediaEvent.COMPLETE, onMediaComplete);
      }
      // function get cue points
      getCuePoints = function (videoID) {
        log("getting cue point data " + videoID)
        cuePointsModule.getCuePoints(videoID, function (cuePointData) {
          // check to see if there are any chapters
          if (typeof cuePointData == "undefined") {
            // no chapters
            hideChapterList();
            chaptersOn = false;
            return;
          }
          else {
            // sort the array to get cue points in order
            cuePointData.sort(function (a, b) {
              return a.time - b.time;
            });
            // remove the preroll and postroll cue points
            cuePointData.splice(0, 1);
            cuePointData.splice((cuePointData.length - 1), 1);
            // double-check to see if there are chapter cue points
            if (cuePointData.length == 0){
              hideChapterList();
              chaptersOn = false;
              return;
            }
            // add formatted time objects for each cue point
            for (var i in cuePointData) {
              cuePointData[i].formattedTime = secondsToTime(cuePointData[i].time);
            }        
            // add the cue point data to the data object for Handlebars
            cuePointDataObj.cuePointData = cuePointData;
            // populate the template with data - standard Handlebars procedure here
            var template = Handlebars.compile(chaptersTemplate);
            var data = cuePointDataObj;
            var results = template(data);
            // inject the results into the page
            $chapterlist.html(results);
            highlight($chapterlist.children().first().attr('id'));
            chaptersOn = true;
            // set click handler for chapter elements
            $('.BCL_chapter').on('click', function () {
              var $this = $(this);
              var newTime = $this.attr("data-time");
              var name = $this.attr("id");
              playChapter(name, newTime);
            });
          };
        });
      };
      // play the chapter
			function playChapter(name,newTime) {
				log("play chapter");
        log(name);
        log(newTime);
        chapterTime = newTime;
				videoPlayer.getIsPlaying(function(isPlaying){
				  if (isPlaying == true) {
				    videoPlayer.seek(chapterTime);
				  } else {
				    videoPlayer.play();
				    // delay by a second to give the video time to buffer
				    var t = window.setTimeout(seekToChapter,1000);
				  }
				});
				highlight(name);
        return;
			}
      // seek utility function
			function seekToChapter(){
			    videoPlayer.getIsPlaying(function(data) {
			      if (data == true) {
			        videoPlayer.seek(chapterTime);
			      } else {
			        videoPlayer.play();
			        // if video wasn't playing, need to allow time for buffering before seek
			        var t = window.setTimeout(seekToChapter,1000);
			        // playChapter(time);
			      }
			    });
          return;
			  }			
      // show chapter list
      showChapterList = function () {
        if (chaptersOn && !chaptersShowing) {
          $chapterlist.fadeIn(300);
          chaptersShowing = true;
        };
        return;
      };
      // hide chapter list
      hideChapterList = function () {
        if (chaptersShowing) {
          $chapterlist.fadeOut(300);
          chaptersShowing = false;
        };
        return;
      };
      // highlighting utility
      highlight = function(name) {
        log(name);
        var thisID = "#" + name;
        //log(thisID);
        var $this = $(thisID);
        // log($this.attr("id"));
        // // de-highlight all items
        $this.siblings().removeClass("BCL_selected");
        $this.addClass("BCL_selected");
        return;
      };
      // seconds to readable time utility
      secondsToTime = function (secs) {
        var hours = Math.floor(secs / (60 * 60));
        if (hours < 10) {
          hours = "0" + hours;
        }
        var divisor_for_minutes = secs % (60 * 60);
        var minutes = Math.floor(divisor_for_minutes / 60);
        if (minutes < 10) {
          minutes = "0" + minutes;
        }
        var divisor_for_seconds = divisor_for_minutes % 60;
        var seconds = Math.ceil(divisor_for_seconds);
        if (seconds < 10) {
          seconds = "0" + seconds;
        }
        var obj = {
          "h":hours,
          "m":minutes,
          "s":seconds
        };
        return obj;
      };
      // for development purposes only: reopen page with HTML5 player
      switchToHTML5 = function () {
        var separator = "?";
        if (document.location.href.indexOf("?", 0) > -1) {
          separator = "&";
        }
        window.location = document.location.href + separator + "forceHTML=true";
      };
      // for development purposes only: switch back to Flash
      switchToFlash = function () {
        var startOfQuery = document.location.href.indexOf("forceHTML", 0) - 1;
        window.location = document.location.href.substring(0, startOfQuery);
      };
      // wrapper for logging
      log = function (message) {
        if (window["console"] && console["log"]) {
          var d = Date.now();
          d = d.toLocaleString();
          console.log(d + ":");
          console.log(message);
          return;
        }
      };
    })();     
  </script>
  </body>
</html>
