

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/video.js | Gallery</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">
    <link type="text/css" rel="stylesheet" href="styles/videojs.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 50px; height: 50px">
        
            <img src="https://brightcovelearning.github.io/Brightcove-API-References/brightcove-player/doc-header-image/bc-logo.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Gallery</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="ClientApi.html">ClientApi</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ClientApi_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ClientApi.html#getAllVideos">getAllVideos</a></li><li><a href="ClientApi.html#getCurrentState">getCurrentState</a></li><li><a href="ClientApi.html#getCurrentVideo">getCurrentVideo</a></li><li><a href="ClientApi.html#off">off</a></li><li><a href="ClientApi.html#on">on</a></li><li><a href="ClientApi.html#once">once</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="ClientApi.html#event:interactionCardPanelClose">interactionCardPanelClose</a></li><li><a href="ClientApi.html#event:interactionCardPanelOpen">interactionCardPanelOpen</a></li><li><a href="ClientApi.html#event:interactionClick">interactionClick</a></li><li><a href="ClientApi.html#event:interactionEnd">interactionEnd</a></li><li><a href="ClientApi.html#event:interactionStart">interactionStart</a></li><li><a href="ClientApi.html#event:playerChanged">playerChanged</a></li><li><a href="ClientApi.html#event:playerLoaded">playerLoaded</a></li><li><a href="ClientApi.html#event:stateChanged">stateChanged</a></li><li><a href="ClientApi.html#event:videoChanged">videoChanged</a></li><li><a href="ClientApi.html#event:videoLoaded">videoLoaded</a></li><li><a href="ClientApi.html#event:videoPaused">videoPaused</a></li><li><a href="ClientApi.html#event:videoStarted">videoStarted</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="ClientApi.html#~InteractivityEvent">InteractivityEvent</a></li><li><a href="ClientApi.html#~Player">Player</a></li><li><a href="ClientApi.html#~Video">Video</a></li></ul></div></li><li><a href="VideoFetcher.html">VideoFetcher</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="VideoFetcher_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="VideoFetcher.html#getVideo">getVideo</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="VideoFetcher.html#emitError">emitError</a></li><li><a href="VideoFetcher.html#emitVideos">emitVideos</a></li><li><a href="VideoFetcher.html#fetch">fetch</a></li><li><a href="VideoFetcher.html#fetchConfigurationVideos">fetchConfigurationVideos</a></li><li><a href="VideoFetcher.html#fetchLiveVodVideos">fetchLiveVodVideos</a></li><li><a href="VideoFetcher.html#fetchManualVideos">fetchManualVideos</a></li><li><a href="VideoFetcher.html#fetchPlaylistVideos">fetchPlaylistVideos</a></li><li><a href="VideoFetcher.html#isExperienceConfigValid">isExperienceConfigValid</a></li><li><a href="VideoFetcher.html#noVideos">noVideos</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="VideoFetcher.html#event:videoError">videoError</a></li><li><a href="VideoFetcher.html#event:videos">videos</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#connect">connect</a></li><li><a href="global.html#deepEqual">deepEqual</a></li><li><a href="global.html#ensureExplicitProtocol">ensureExplicitProtocol</a></li><li><a href="global.html#ensureProtocol">ensureProtocol</a></li><li><a href="global.html#escapeForHtml">escapeForHtml</a></li><li><a href="global.html#escapeForRegex">escapeForRegex</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllVideosFromState">getAllVideosFromState</a></li><li><a href="global.html#getCssUrl">getCssUrl</a></li><li><a href="global.html#getFontResizeFunction">getFontResizeFunction</a></li><li><a href="global.html#getFontSize">getFontSize</a></li><li><a href="global.html#getHelperTextKey">getHelperTextKey</a></li><li><a href="global.html#getIn">getIn</a></li><li><a href="global.html#getLocation">getLocation</a></li><li><a href="global.html#getMinMaxFontSizes">getMinMaxFontSizes</a></li><li><a href="global.html#getPlaylist">getPlaylist</a></li><li><a href="global.html#getPoster">getPoster</a></li><li><a href="global.html#getReferrer">getReferrer</a></li><li><a href="global.html#getSourceUrl">getSourceUrl</a></li><li><a href="global.html#getSwipeOffset">getSwipeOffset</a></li><li><a href="global.html#getSwipeVideoChange">getSwipeVideoChange</a></li><li><a href="global.html#getThumbnail">getThumbnail</a></li><li><a href="global.html#getUrlForVideo">getUrlForVideo</a></li><li><a href="global.html#getVideosArrayFromState">getVideosArrayFromState</a></li><li><a href="global.html#getVideosFromState">getVideosFromState</a></li><li><a href="global.html#getVideosFromStateForConfig">getVideosFromStateForConfig</a></li><li><a href="global.html#getVideosOrEmpty">getVideosOrEmpty</a></li><li><a href="global.html#hasProtocol">hasProtocol</a></li><li><a href="global.html#isDataProp">isDataProp</a></li><li><a href="global.html#isNonNullObject">isNonNullObject</a></li><li><a href="global.html#isSecure">isSecure</a></li><li><a href="global.html#joinStyleClassNames">joinStyleClassNames</a></li><li><a href="global.html#maxNonNull">maxNonNull</a></li><li><a href="global.html#merge">merge</a></li><li><a href="global.html#mergeIn">mergeIn</a></li><li><a href="global.html#minNonNull">minNonNull</a></li><li><a href="global.html#noVideos">noVideos</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#parseQueryString">parseQueryString</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#sameMembers">sameMembers</a></li><li><a href="global.html#selectHtmlProps">selectHtmlProps</a></li><li><a href="global.html#selectProps">selectProps</a></li><li><a href="global.html#selectSvgProps">selectSvgProps</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setFontSizes">setFontSizes</a></li><li><a href="global.html#setIn">setIn</a></li><li><a href="global.html#shallowEqual">shallowEqual</a></li><li><a href="global.html#shallowEqualArray">shallowEqualArray</a></li><li><a href="global.html#stringify">stringify</a></li><li><a href="global.html#stringifyQuery">stringifyQuery</a></li><li><a href="global.html#toQueryString">toQueryString</a></li><li><a href="global.html#updateTextSize">updateTextSize</a></li><li class="hidden"><a href="global.html#URLParts">URLParts</a></li><li><a href="global.html#videoConfigHasChanged">videoConfigHasChanged</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const constants = require('../constants');
const playbackApi = require('./playbackApi');
const string = require('./string');
const { isSecure } = require('./url');
const { getConfigurationPath } = require('./config');
const { getIn } = require('./immutable');
const compare = require('./compare');
const manifest = require('../manifest');
const vars = require('./vars');

/**
 * Empty Array constant representing no videos, used to make our reference comparisons for PureComponent's work better
 * rather than creating a new empty array.
 */
const noVideos = [];

function getTypeAndId (videoId) {
  const typeMatch = /^([^:]+):(.*)/.exec(videoId);
  if (typeMatch) {
    return {
      type: typeMatch[1],
      id: typeMatch[2],
    };
  }
  return {
    type: constants.video.sources.videocloud,
    id: videoId,
  };
}

function fetch (videoId, experience) {
  const { accountId, playbackApiBaseUrl, youtubeApiBaseUrl, policyKey, youtubeKey } = experience;
  let { type, id } = getTypeAndId(videoId);
  let baseUrl;

  if (type === constants.video.sources.youtube) {
    baseUrl = playbackApi.getYouTubeBaseUrl(youtubeApiBaseUrl, accountId);
    return playbackApi.get(`${baseUrl}/videos/${id}`, youtubeKey)
      .then(data => {
        if (data.items[0]) {
          return Object.assign(data.items[0], {
            id: videoId,
          });
        }
      });
  }

  if (type === constants.video.sources.ref) {
    id = `ref:${id}`;
  }

  baseUrl = playbackApi.getPlaybackApiBaseUrl(playbackApiBaseUrl, accountId);
  return playbackApi.get(`${baseUrl}/videos/${id}`, policyKey);
}

//Unfortunately, the player transforms the Playback API response, so we should do that too to avoid any confusion:
//https://bithub.brightcove.com/videocloud/videojs-bc-catalog/blob/master/src/plugin.js#L255
//We do this on the actual video object to avoid unnecessary data copying
function transformPlaybackResponse (video, configuration, index) {
  if (video) {
    Object.keys(video)
      .filter(key => key.match(string.regexSnake))
      .forEach(snake => {
        video[string.snakeToCamel(snake)] = video[snake];
      });

    if (video.duration) {
      video.duration /= constants.date.millisPerSecond;
    }

    video.galleryVideoIndex = index;
    video.galleryVideoConfiguration = configuration;
  }
}

/**
 * Gets the URL of the video source in a downloadable container with the highest bitrate
 */
function getSourceUrl (video) {
  //We want to find a source which is not a stream or a stream container and which has the highest avg bitrate.
  const source = video.sources &amp;&amp; video.sources.reduce((prev, source) => {
    if (
      source.src &amp;&amp;
      constants.video.contentSourceContainers.includes(source.container) &amp;&amp;
      (!prev || prev.avg_bitrate &lt; source.avg_bitrate)
    ) {
      return source;
    }
    return prev;
  }, null);

  return source ? source.src : null;
}

/**
 * Retrieves an https poster image from a video if available
 */
function getPoster (video) {
  if (!video) {
    return;
  }
  const { poster, posterSources } = video;
  if (!posterSources) {
    return poster;
  }
  //Try to find an https poster image, fall back to the standard poster if we can't
  const posterSource = posterSources.find(source => isSecure(source.src));
  return posterSource ? posterSource.src : poster;
}

/**
 * Retrieves an https thumbnail image from a video if available
 */
function getThumbnail (video) {
  if (!video) {
    return;
  }
  const { thumbnail, thumbnailSources } = video;
  if (!thumbnailSources) {
    return thumbnail;
  }
  //Try to find an https poster image, fall back to the standard poster if we can't
  const thumbnailSource = thumbnailSources.find(source => isSecure(source.src));
  return thumbnailSource ? thumbnailSource.src : thumbnail;
}

/**
 * Checks to see whether a video configuration has been modified.  Currently allows more false positives through,
 * which isn't terrible as the videos will always be up-to-date, but this does mean we may be fetching more times
 * than we need to be.
 */
function videoConfigHasChanged (oldVideos, newVideos) {
  if (!newVideos !== !oldVideos) {
    //newVideos either was null and now isn't, or vice-versa
    return true;
  } else if (!newVideos) {
    //Both oldVideos and newVideos are null, no changes to the configuration
    return false;
  }
  const { type: oldType, videoIds: oldVideoIds, playlistId: oldPlaylistId } = oldVideos;
  const { type, videoIds, playlistId } = newVideos;

  if (type !== oldType) {
    //type was changed
    return true;
  } else if (type === constants.video.types.playlist) {
    //Check to see if the playlist Ids are different
    return vars.interpolate(playlistId) !== vars.interpolate(oldPlaylistId);
  } else if (!videoIds !== !oldVideoIds) {
    //videoIds either was null and now isn't, or vice-versa
    return true;
  } else if (videoIds) {
    //Check to see if either the lengths don't match or if the videoIds don't match
    return !compare.shallowEqualArray(videoIds, oldVideoIds);
  }
}

/**
 * Retrieves a videos array from the state given the configuration name, or a video configuration reference string.
 *
 * @param {object} state Application state
 * @param {string} configuration Configuration name
 * @returns {Array|string|null} Video array or configuration reference
 */
function getVideosFromStateForConfig (state, configuration) {
  return getIn(state, getConfigurationPath(configuration, 'videos'));
}

/**
 * Retrieves a videos array from the state given the configuration name.  If this configuration's videos is actually
 * a reference to another configuration, this function returns an empty array of videos (does not actually follow the
 * reference).
 *
 * @param state Application state
 * @param configuration Configuration name
 * @returns {Array} Videos array or empty array
 */
function getVideosArrayFromState (state, configuration) {
  const videos = getVideosFromStateForConfig(state, configuration);
  return Array.isArray(videos) ? videos : noVideos;
}

/**
 * Retrieves a videos array from the state given the configuration name and will follow references to another
 * configuration for a single hop.  Returns an empty array of videos if the referenced configuration is also a
 * reference.
 *
 * @param state Application state
 * @param configuration Configuration name
 * @returns {Array} Videos array or empty array
 */
function getVideosFromState (state, configuration) {
  const videos = getIn(state, getConfigurationPath(configuration, 'videos'));
  if (typeof videos === 'string') {
    return getVideosArrayFromState(state, videos);
  }
  return videos || noVideos;
}

/**
 * Retrieves all videos in the current experience from the state across all configurations.
 *
 * @param state Application state
 * @returns {Array} Videos array
 */
function getAllVideosFromState (state) {
  const videoConfigurations = manifest.getVideoConfigurations();
  if (!videoConfigurations.length) {
    return getVideosArrayFromState(state);
  }
  return videoConfigurations.reduce((allVideos, config) => {
    return allVideos.concat(getVideosArrayFromState(state, config.name));
  }, []);
}

/**
 * Retrieves videos from the state, and if no videos exists creates an array of null objects to create empty video
 * containers
 *
 * @param state Application state
 * @param props Component props
 * @param emptyVideoCount Number of null videos to create if the videos in the state is empty
 * @returns {Array} Videos array
 */
function getVideosOrEmpty (state, props, emptyVideoCount) {
  const videos = props.videos || getVideosFromState(state, props.configuration);
  if (__EDITOR__ &amp;&amp; !videos.length) {
    return Array.from(new Array(emptyVideoCount));
  }
  return videos;
}

function shouldShowDownload (experience, video) {
  const {
    allowDownloads, downloadCustomField, downloadCustomFieldValue,
  } = getIn(experience, ['videos'], {});
  const { downloadOptions } = constants.video;

  if (allowDownloads === downloadOptions.all) {
    return true;
  } else if (allowDownloads !== downloadOptions.customField) {
    return false;
  }
  return getIn(video, ['customFields', downloadCustomField]) === downloadCustomFieldValue;
}

/**
 * Gets the i18n helper text key for use in the editor
 */
function getHelperTextKey (configurationName) {
  let configuration = manifest;
  if (configurationName) {
    configuration = (manifest.configurations || []).find(config => config.name === configurationName);
  }
  if (!getIn(configuration, ['options', 'singleVideo'])) {
    return 'add_videos';
  }
  return 'select_video';
}

module.exports = {
  getTypeAndId,
  fetch,
  transformPlaybackResponse,
  getSourceUrl,
  getPoster,
  getThumbnail,
  videoConfigHasChanged,
  getVideosOrEmpty,
  getVideosArrayFromState,
  getVideosFromStateForConfig,
  getVideosFromState,
  getAllVideosFromState,
  shouldShowDownload,
  getHelperTextKey,
};
</code></pre>
        </article>
    </section>




</div>

    <footer>
        <img class="logo" src="https://brightcovelearning.github.io/Brightcove-API-References/brightcove-player/doc-header-image/bc-logo.png" style="width: 50px; height: 46px">
        <div class="footer-text"><span class='copyright'>©2018 <a href='https://brightcove.com' target='_blank'>Brightcove, Inc</a>.</div>
    </footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
