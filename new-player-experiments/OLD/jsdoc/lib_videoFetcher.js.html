

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/videoFetcher.js | Gallery</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">
    <link type="text/css" rel="stylesheet" href="styles/videojs.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 50px; height: 50px">
        
            <img src="https://brightcovelearning.github.io/Brightcove-API-References/brightcove-player/doc-header-image/bc-logo.png" width="100%" height="100%">
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Gallery</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="ClientApi.html">ClientApi</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ClientApi_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="ClientApi.html#getAllVideos">getAllVideos</a></li><li><a href="ClientApi.html#getCurrentState">getCurrentState</a></li><li><a href="ClientApi.html#getCurrentVideo">getCurrentVideo</a></li><li><a href="ClientApi.html#off">off</a></li><li><a href="ClientApi.html#on">on</a></li><li><a href="ClientApi.html#once">once</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="ClientApi.html#event:interactionCardPanelClose">interactionCardPanelClose</a></li><li><a href="ClientApi.html#event:interactionCardPanelOpen">interactionCardPanelOpen</a></li><li><a href="ClientApi.html#event:interactionClick">interactionClick</a></li><li><a href="ClientApi.html#event:interactionEnd">interactionEnd</a></li><li><a href="ClientApi.html#event:interactionStart">interactionStart</a></li><li><a href="ClientApi.html#event:playerChanged">playerChanged</a></li><li><a href="ClientApi.html#event:playerLoaded">playerLoaded</a></li><li><a href="ClientApi.html#event:stateChanged">stateChanged</a></li><li><a href="ClientApi.html#event:videoChanged">videoChanged</a></li><li><a href="ClientApi.html#event:videoLoaded">videoLoaded</a></li><li><a href="ClientApi.html#event:videoPaused">videoPaused</a></li><li><a href="ClientApi.html#event:videoStarted">videoStarted</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="ClientApi.html#~InteractivityEvent">InteractivityEvent</a></li><li><a href="ClientApi.html#~Player">Player</a></li><li><a href="ClientApi.html#~Video">Video</a></li></ul></div></li><li><a href="VideoFetcher.html">VideoFetcher</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="VideoFetcher_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="VideoFetcher.html#getVideo">getVideo</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="VideoFetcher.html#emitError">emitError</a></li><li><a href="VideoFetcher.html#emitVideos">emitVideos</a></li><li><a href="VideoFetcher.html#fetch">fetch</a></li><li><a href="VideoFetcher.html#fetchConfigurationVideos">fetchConfigurationVideos</a></li><li><a href="VideoFetcher.html#fetchLiveVodVideos">fetchLiveVodVideos</a></li><li><a href="VideoFetcher.html#fetchManualVideos">fetchManualVideos</a></li><li><a href="VideoFetcher.html#fetchPlaylistVideos">fetchPlaylistVideos</a></li><li><a href="VideoFetcher.html#isExperienceConfigValid">isExperienceConfigValid</a></li><li><a href="VideoFetcher.html#noVideos">noVideos</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="VideoFetcher.html#event:videoError">videoError</a></li><li><a href="VideoFetcher.html#event:videos">videos</a></li></ul></div></li></ul></div><div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#connect">connect</a></li><li><a href="global.html#deepEqual">deepEqual</a></li><li><a href="global.html#ensureExplicitProtocol">ensureExplicitProtocol</a></li><li><a href="global.html#ensureProtocol">ensureProtocol</a></li><li><a href="global.html#escapeForHtml">escapeForHtml</a></li><li><a href="global.html#escapeForRegex">escapeForRegex</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getAllVideosFromState">getAllVideosFromState</a></li><li><a href="global.html#getCssUrl">getCssUrl</a></li><li><a href="global.html#getFontResizeFunction">getFontResizeFunction</a></li><li><a href="global.html#getFontSize">getFontSize</a></li><li><a href="global.html#getHelperTextKey">getHelperTextKey</a></li><li><a href="global.html#getIn">getIn</a></li><li><a href="global.html#getLocation">getLocation</a></li><li><a href="global.html#getMinMaxFontSizes">getMinMaxFontSizes</a></li><li><a href="global.html#getPlaylist">getPlaylist</a></li><li><a href="global.html#getPoster">getPoster</a></li><li><a href="global.html#getReferrer">getReferrer</a></li><li><a href="global.html#getSourceUrl">getSourceUrl</a></li><li><a href="global.html#getSwipeOffset">getSwipeOffset</a></li><li><a href="global.html#getSwipeVideoChange">getSwipeVideoChange</a></li><li><a href="global.html#getThumbnail">getThumbnail</a></li><li><a href="global.html#getUrlForVideo">getUrlForVideo</a></li><li><a href="global.html#getVideosArrayFromState">getVideosArrayFromState</a></li><li><a href="global.html#getVideosFromState">getVideosFromState</a></li><li><a href="global.html#getVideosFromStateForConfig">getVideosFromStateForConfig</a></li><li><a href="global.html#getVideosOrEmpty">getVideosOrEmpty</a></li><li><a href="global.html#hasProtocol">hasProtocol</a></li><li><a href="global.html#isDataProp">isDataProp</a></li><li><a href="global.html#isNonNullObject">isNonNullObject</a></li><li><a href="global.html#isSecure">isSecure</a></li><li><a href="global.html#joinStyleClassNames">joinStyleClassNames</a></li><li><a href="global.html#maxNonNull">maxNonNull</a></li><li><a href="global.html#merge">merge</a></li><li><a href="global.html#mergeIn">mergeIn</a></li><li><a href="global.html#minNonNull">minNonNull</a></li><li><a href="global.html#noVideos">noVideos</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#parseQueryString">parseQueryString</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#sameMembers">sameMembers</a></li><li><a href="global.html#selectHtmlProps">selectHtmlProps</a></li><li><a href="global.html#selectProps">selectProps</a></li><li><a href="global.html#selectSvgProps">selectSvgProps</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setFontSizes">setFontSizes</a></li><li><a href="global.html#setIn">setIn</a></li><li><a href="global.html#shallowEqual">shallowEqual</a></li><li><a href="global.html#shallowEqualArray">shallowEqualArray</a></li><li><a href="global.html#stringify">stringify</a></li><li><a href="global.html#stringifyQuery">stringifyQuery</a></li><li><a href="global.html#toQueryString">toQueryString</a></li><li><a href="global.html#updateTextSize">updateTextSize</a></li><li class="hidden"><a href="global.html#URLParts">URLParts</a></li><li><a href="global.html#videoConfigHasChanged">videoConfigHasChanged</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const EventEmitter = require('eventemitter3');
const playlistLib = require('./playlist');
const videoLib = require('./video');
const constants = require('../constants');
const { getConfigurationPath } = require('./config');
const { get, getIn } = require('./immutable');
const manifest = require('../manifest');

function getErrorCode (err) {
  //Playback API error codes
  const error = getIn(err, ['body', 0]);
  const errorCode = get(error, 'error_subcode') || get(error, 'error_code');
  if (errorCode) {
    return errorCode;
  }
  //Fallback to using the statusCode
  if (err.statusCode === 404) {
    return constants.video.errorCodes.notFound;
  }
  return constants.video.errorCodes.notPlayable;
}

/**
 * Helper class for fetching videos from an experience given the configuration.  Emits 'video' events with arrays
 * of videos as they are fetched.
 */
class VideoFetcher extends EventEmitter {
  constructor (experience, configuration) {
    super();
    this.experience = experience;
    this.videos = getIn(experience, getConfigurationPath(configuration, 'videos')) || {};
  }

  /**
   * Helper function for ensuring the experience has a valid configuration to perform video fetching
   * @returns {boolean} Whether the experience configuration is valid
   */
  isExperienceConfigValid () {
    const { accountId, policyKey } = this.experience;
    return accountId &amp;&amp; policyKey;
  }

  /**
   * Helper function for emitting videos
   * @param {Array|String} videos Array of video metadata or string reference to a video configuration
   * @param {boolean} done Whether this is the last page of videos being fetched
   */
  emitVideos (videos, done) {
    /**
     * Videos event
     * @event VideoFetcher#videos
     * @type {object}
     * @param {array} videos Array of video metadata
     */
    this.emit('videos', { videos, done });
  }

  /**
   * Helper function for emitting video errors
   * @param {string} videoId Video ID
   * @param {string} errorCode Error code
   */
  emitError (videoId, errorCode) {
    /**
     * Video error event
     * @event VideoFetcher#videoError
     * @type {object}
     * @param {string} videoId ID of the video that threw the error
     * @param {string} errorCode Error code
     */
    this.emit('videoError', {
      videoId,
      errorCode,
    });
  }

  /**
   * Helper function for emitting an empty array of videos
   * @returns {Promise} Promise that just resolves instantly
   */
  noVideos () {
    this.emitVideos([], true);
  }

  /**
   * Safely fetches a video and ignores it if it cannot be fetched
   * @param {string} videoId Video ID
   * @returns {Promise} Promise that resolves to the video metadata (or undefined if the video cannot be fetched)
   */
  getVideo = async videoId => {
    try {
      return await videoLib.fetch(videoId, this.experience);
    } catch (err) {
      //Skip the video if it's not found (possibly deleted or hasn't made its way to the CDN)
      this.emitError(videoId, getErrorCode(err));
    }
  };

  /**
   * Fetches playlist videos for the given experience and configuration
   * @returns {Promise} Promise that resolves when fetching is completed
   */
  async fetchPlaylistVideos () {
    const { pageSize } = constants.video;
    const { playlistId } = this.videos;
    if (!this.isExperienceConfigValid() || !playlistId) {
      return this.noVideos();
    }
    let offset = 0;
    let playlist;
    do {
      playlist = await playlistLib.fetch(playlistId, this.experience, offset, pageSize);
      const { videos, nextPageToken } = playlist;

      //Emit the videos to whoever is listening
      this.emitVideos(videos);

      offset = nextPageToken != null ? nextPageToken : offset + pageSize;
    } while (playlist.videos &amp;&amp; playlist.videos.length === pageSize);
  }

  /**
   * Fetches manual videos for the given experience and configuration
   * @returns {Promise} Promise that resolves when fetching is completed
   */
  async fetchManualVideos () {
    const { pageSize } = constants.video;
    const { videoIds } = this.videos;
    if (!this.isExperienceConfigValid() || !videoIds) {
      return this.noVideos();
    }

    //Retrieve individual video information
    for (let offset = 0; offset &lt; videoIds.length; offset += pageSize) {
      const videoPageIds = videoIds.slice(offset, offset + pageSize);

      const videos = await Promise.all(videoPageIds.map(this.getVideo));
      //Emit the videos to whoever is listening
      this.emitVideos(videos);
    }
  }

  /**
   * Fetches a configuration reference videos (just emits the configured configuration name)
   * @returns {Promise} Promise that resolves when fetching is complete
   */
  fetchConfigurationVideos () {
    const { configuration } = this.videos;
    this.emitVideos(configuration || []);
  }

  /**
   * Fetches the first live configuration reference videos (just emits the first live configuration name)
   * @returns {Promise} Promise that resolves when fetching is completed
   */
  fetchLiveVodVideos () {
    //Find the first video configuration with a live video option, then treat it like a reference to that config
    const configuration = manifest.getVideoConfigurations().find(config => getIn(config, ['options', 'liveVideo']));
    this.emitVideos(configuration ? configuration.name : []);
  }

  /**
   * Fetches videos for the given experience and configuration
   * @returns {Promise} Promise that resolves when fetching is completed
   */
  async fetch () {
    const { type } = this.videos;
    switch (type) {
      case constants.video.types.playlist:
        return await this.fetchPlaylistVideos();
      case constants.video.types.configuration:
        return await this.fetchConfigurationVideos();
      case constants.video.types.liveVideoConfiguration:
        return await this.fetchLiveVodVideos();
      default:
        return await this.fetchManualVideos();
    }
  }
}

module.exports = VideoFetcher;
</code></pre>
        </article>
    </section>




</div>

    <footer>
        <img class="logo" src="https://brightcovelearning.github.io/Brightcove-API-References/brightcove-player/doc-header-image/bc-logo.png" style="width: 50px; height: 46px">
        <div class="footer-text"><span class='copyright'>Â©2018 <a href='https://brightcove.com' target='_blank'>Brightcove, Inc</a>.</div>
    </footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
